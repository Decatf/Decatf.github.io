function drawLineChart(t,n,a,c){var o=n.xScale,s=n.yScale;t.beginPath();for(var u=null,e=0;e<a.length;e++)if(0==e){var r=o(n.dataMapFuncX(a[e]));u=r;var i=n.dataMapFuncY(a[e]);if(null==i||isNaN(i))continue;var l=s(i);t.moveTo(r,l)}else{var r=o(n.dataMapFuncX(a[e])),i=n.dataMapFuncY(a[e]);if(null==i||isNaN(i))continue;var l=s(i);if(t.lineTo(r,l),e==a.length-1&&null!=c){var h=s(c);t.lineTo(r,h),t.lineTo(u,h),t.closePath(),t.fill()}}t.stroke()}function drawOhlcChart(t,o,a,h){var l=o.xScale,r=o.yScale,u=function(t){return t.y[0]==t.y[3]?"black":t.y[0]>t.y[3]?"red":"green"};t.lineWidth=1;var s;s=0==t.lineWidth%2?0:.5;for(var e=0;e<a.length;e++){t.strokeStyle=u(a[e]),t.beginPath();var i=~~l(o.dataMapFuncX(a[e]))+s,n=r(a[e].y[1]),c=r(a[e].y[2]);t.moveTo(i,n),t.lineTo(i,c),t.stroke(),n=~~r(a[e].y[0])+s,t.moveTo(i,n),t.lineTo(i-h,n),t.stroke(),n=~~r(a[e].y[3])+s,t.moveTo(i,n),t.lineTo(i+h,n),t.stroke(),t.closePath()}}function drawBarChart(n,a,e,i){var h=a.xScale,r=a.yScale;a.height-a.margin.top-a.margin.bottom;var u="black";n.lineWidth=1,n.strokeStyle=u;for(var t=0;t<e.length;t++){n.beginPath();var s,c=h(e[t].index)-i/2;if(null!=e[t].y0&&!isNaN(e[t].y0)){s=r(e[t].y0);var l=i,o=r(0);n.fillRect(c,s,l,o)}}}function ChartCollection(a,s){ChartCollection.prototype.onBrush=function(){var n=this.charts,s=this.chartContext.brush,e=this.chartContext,c=Date.now();if(c-this.onBrushTimer>this.brushTimerAvg){var i,r;if(s.empty())i=e.chartData;else{var u=s.extent();i=e.chartData.filter(function(a,t,e){return u[0]<=e[t].x&&e[t].x<=u[1]})}r=d3.extent(i.map(e.dataMapFuncX));for(var a=[0,0],o=!1,h=!1,t=0;t<e.chartData.length&&(o||r[0]!=e.chartData[t].x||(a[0]=t,o=!0),h||r[1]!=e.chartData[t].x||(a[1]=t,h=!0),!o||!h);t++);for(var t=0;t<n.length;t++)n[t].onBrush.call(n[t],s,a,a);var l=Date.now();this.brushTimerAvg=(.4*this.brushTimerAvg+.6*(l-c))/1.95,this.onBrushTimer=l}},ChartCollection.prototype.onBrushEnd=function(){},ChartCollection.prototype.update=function(s,r){var i=this.charts.length+1,n=9*s/10-this.margin.left-this.margin.right,e=8*r/10-i*this.margin.top-this.margin.bottom;this.svg.attr("width",n+this.margin.left+this.margin.right).attr("height",e+i*this.margin.top+this.margin.bottom);var a;a=n-.1*e,t=.1*e,this.chartContext.update(a,t,this.margin.left+t/2,this.margin.top+(.9*e+this.margin.top)),a=n,t=.7*e,this.charts[0].update.call(this.charts[0],a,t,this.margin.left,this.margin.top),this.charts[0].onBrush.call(this.charts[0],this.chartContext.brush),this.charts[0].updateCursor(),a=n,t=.2*e,this.charts[1].update.call(this.charts[1],a,t,this.margin.left,this.margin.top+(.7*e+this.margin.top)),this.charts[1].onBrush.call(this.charts[1],this.chartContext.brush),this.charts[1].updateCursor();var o=document.getElementById("chartContentDiv"),h="-"+(r-i*this.margin.top-this.margin.bottom)/2+"px";o.style.marginTop=h},ChartCollection.prototype.onMouseMove=function(){d3.event.preventDefault(),d3.event.stopPropagation();var t=Date.now();if(t-this.mouseMoveTimer>this.mouseMoveTime){for(i=0;i<this.charts.length;i++)this.charts[i].onMouseMove.call(this.charts[i]);this.mouseMoveTimer=t}},ChartCollection.prototype.onTouchStart=function(){d3.event.preventDefault(),d3.event.stopPropagation();var t=Date.now();if(t-this.mouseMoveTimer>this.mouseMoveTime){for(i=0;i<this.charts.length;i++)this.charts[i].onTouchMove.call(this.charts[i]);this.mouseMoveTimer=t}},ChartCollection.prototype.onTouchMove=function(){d3.event.preventDefault(),d3.event.stopPropagation();var t=Date.now();if(t-this.mouseMoveTimer>this.mouseMoveTime){for(i=0;i<this.charts.length;i++)this.charts[i].onTouchMove.call(this.charts[i]);this.mouseMoveTimer=t}},this.charts=[];var n=3;this.margin={top:10,right:80,bottom:10,left:10},this.barMargin={side:1,top:10},this.width=960-this.margin.left-this.margin.right,this.height=600-n*this.margin.top-this.margin.bottom,this.patternAnnotations=[];var r=Date.now();this.mouseMoveTime=50,this.mouseMoveTimer=r,this.brushTimerAvg=50,this.onBrushTimer=r,this.svg=d3.select("#chart").append("svg").attr("class","chart").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+n*this.margin.top+this.margin.bottom);var e;e=function(t){return t.x.toDateString()+" - O: "+t.y[0].toFixed(2)+" H: "+t.y[1].toFixed(2)+" L: "+t.y[2].toFixed(2)+" C: "+t.y[3].toFixed(2)},this.charts.push(new CanvasCandlestickChart({svg:this.svg,data:a,width:this.width,height:.7*this.height,margin:this.margin,barMargin:this.barMargin,translateX:this.margin.left,translateY:this.margin.top,name:"CandleStickChart",dataMapFuncX:function(t){return t.index},dataMapFuncY:function(t){return t.y0},cursorTextFunc:e,onMouseMove:this.onMouseMove.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchMove:this.onTouchMove.bind(this),yDomainPadding:.05})),this.charts.CandleStickChart=this.charts[0],e=function(t){return"Volume: "+d3.format(",")(t.y0)},this.charts.push(new CanvasBarChart({svg:this.svg,data:s,width:this.width,height:.2*this.height,margin:this.margin,barMargin:this.barMargin,translateX:this.margin.left,translateY:this.margin.top+(.7*this.height+this.margin.top),name:"BarChart",dataMapFuncX:function(t){return t.index},dataMapFuncY:function(t){return t.y0},cursorTextFunc:e,onMouseMove:this.onMouseMove.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchMove:this.onTouchMove.bind(this),yDomainMin:0})),this.charts.BarChart=this.charts[1],this.charts.BarChart.yAxis.ticks(5);var t=.1*this.height-2,o=this.width-t;this.chartContext=new ChartContext({svg:this.svg,data:a,width:o,height:t,margin:this.margin,translateX:this.margin.left+t,translateY:this.margin.top+(.9*this.height+this.margin.top)}),this.chartContext.brush.on("brushend",this.onBrushEnd.bind(this)),this.chartContext.brush.on("brush",this.onBrush.bind(this))}function ChartContext(t){ChartContext.prototype.update=function(n,t,i,r){var s=this.brush.extent();this.contextWidth=n,this.contextHeight=t,this.contextXScale.range([0,this.contextWidth]).domain(d3.extent(this.chartData.map(this.dataMapFuncX))),this.contextYScale.range([this.contextHeight,0]).domain(d3.extent(this.chartData.map(this.dataMapFuncY))),this.contextAxis.scale(this.contextXScale).orient("bottom"),this.contextPathFunction.x(function(t){return e(t.x)}).y0(this.contextHeight).y1(function(t){return a(t.y0)}),this.context.attr("transform","translate("+i+","+r+")"),this.context.select("path").datum(this.chartData).attr("d",this.contextPathFunction),this.context.select(".x.axis").attr("transform","translate(0, "+t+")").call(this.contextAxis),this.brush.extent(s),this.context.select(".x.brush").call(this.brush).selectAll("rect").attr("y",0).attr("height",this.contextHeight)},this.svg=t.svg,this.chartData=t.data,this.margin=t.margin,this.contextWidth=t.width,this.contextHeight=t.height,this.dataMapFuncX=function(t){return t.x},this.dataMapFuncY=function(t){return t.y0},this.contextXScale=d3.time.scale().range([0,this.contextWidth]).domain(d3.extent(this.chartData.map(this.dataMapFuncX))),this.contextYScale=d3.scale.linear().range([this.contextHeight,0]).domain(d3.extent(this.chartData.map(this.dataMapFuncY))),this.contextAxis=d3.svg.axis().scale(this.contextXScale).orient("bottom");var e=this.contextXScale,a=this.contextYScale;this.contextPathFunction=d3.svg.area().defined(function(t){return null!=t.y0&&!isNaN(t.y0)}).x(function(t){return e(t.x)}).y0(this.contextHeight).y1(function(t){return a(t.y0)}),this.brush=d3.svg.brush().x(this.contextXScale).on("brush",onBrushEvents),this.context=this.svg.append("g").attr("class","context").attr("transform","translate("+t.translateX+","+t.translateY+")"),this.context.append("path").attr("id","context_path").datum(this.chartData).attr("d",this.contextPathFunction),this.context.append("g").attr("class","x axis").attr("transform","translate(0,"+this.contextHeight+")").call(this.contextAxis),this.context.append("g").attr("class","x brush").call(this.brush).selectAll("rect").attr("y",0).attr("height",this.contextHeight),this.context.selectAll(".resize.e").append("rect").attr("class","contextResizeHandle").attr("width",this.contextHeight/2).attr("height",this.contextHeight).attr("transform","translate(0, 0)").on("mousemove",onBrushHandleTouch).on("touchmove",onBrushHandleTouch).on("touchstart",onBrushHandleTouch),this.context.selectAll(".resize.w").append("rect").attr("class","contextResizeHandle").attr("width",this.contextHeight/2).attr("height",this.contextHeight).attr("transform","translate("+-this.contextHeight/2+", 0)").on("mousemove",onBrushHandleTouch).on("touchmove",onBrushHandleTouch).on("touchstart",onBrushHandleTouch),this.context.selectAll("rect.extent").on("mousemove",onBrushHandleTouch).on("touchmove",onBrushHandleTouch).on("touchstart",onBrushHandleTouch),this.context.selectAll("g.x.brush").on("mousemove",onBrushEvents).on("touchmove",onBrushEvents).on("touchstart",onBrushEvents)}function onBrushHandleTouch(){d3.event.preventDefault()}function onBrushEvents(){d3.event.preventDefault()}function Chart(t){this.svg=t.svg,this.margin=t.margin,this.width=t.width,this.height=t.height,this.translateX=t.translateX,this.translateY=t.translateY,this.chartData=t.data,this.dataMapFuncX=t.dataMapFuncX,this.dataMapFuncY=t.dataMapFuncY,this.cursorText=t.cursorTextFunc,this.yDomainMin="undefined"==typeof t.yDomainMin?null:t.yDomainMin,this.yDomainMax="undefined"==typeof t.yDomainMax?null:t.yDomainMax,this.yDomainPadding="undefined"==typeof t.yDomainPadding?0:t.yDomainPadding,this.name=t.name,this.chartContainer="";var e=this.height-this.margin.top-this.margin.bottom;this.visibleSegments=[],this.patternAnnotations=[],this.chartIndicators=[],this.xScale=d3.scale.linear().range([0,this.width]),this.yScale=d3.scale.linear().range([e,0]),this.xScale.domain(d3.extent(this.chartData.map(this.dataMapFuncX))),this.yScale.domain(d3.extent(this.chartData.map(this.dataMapFuncY))),this.xAxis=d3.svg.axis().scale(this.xScale).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.yScale).orient("right");var a=this.chartData;this.xAxis.tickFormat(function(t){return a[t]?a[t].x.getDate()+"/"+(a[t].x.getMonth()+1)+"/"+a[t].x.getFullYear():void 0});var n=this.xScale,i=this.yScale;this.pathFunction=d3.svg.line().defined(function(t){return null!=t&&null!=t.y0&&!isNaN(t.y0)}).x(function(t){return n(t.index)}).y(function(t){return i(t.y0)}),this.svg.append("defs").append("clipPath").attr("id","clip-"+this.name).append("rect").attr("class","clipRect").attr("width",this.width).attr("height",e),this.chartContainer=this.svg.append("g").attr("class",this.name).attr("transform","translate("+t.translateX+","+t.translateY+")"),this.chartContainer.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(this.xAxis),this.chartContainer.append("g").attr("class","y axis").attr("transform","translate("+this.width+",0)").call(this.yAxis),this.overlay=this.chartContainer.append("rect").attr("class","mouse_overlay").attr("width",this.width).attr("height",e).on("mousemove",t.onMouseMove).on("touchmove",t.onTouchMove).on("touchstart",t.onTouchStart),this.chartContainer.append("svg:line").attr("class","cursor_line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",e),this.chartContainer.append("text").attr("class","cursor_value").attr("x",10).attr("y",10).attr("font-family","sans-serif").attr("font-size","11px").attr("fill","black"),Chart.prototype.addIndicator=function(t){this.chartIndicators[t.id]=t,this.chartContainer.insert("path","g.x.axis").attr("class","chart_indicator").attr("id",t.id).attr("clip-path","url(#clip-"+this.name+")").datum(t.indicatorData).attr("d",t.pathFunction).attr("stroke","blue").attr("fill","none").attr("stroke-width","0.05%"),this.chartIndicators.push(t)},Chart.prototype.showPatternAnnotation=function(a){for(var n=this.patternAnnotations.filter(function(t){return a==t.patternId}),e=0;e<n[0].patternSegments.length;e++){var i=n[0].patternSegments[e],o=i.startDate,h=i.endDate,r=this.chartData.filter(function(a,t,e){return o==toIntDate(e[t].x)}),s=this.chartData.filter(function(a,t,e){return h==toIntDate(e[t].x)}),t=[];1==r.length&&1==s.length&&(t.push(r[0].index),t.push(s[0].index),t.push(a)),this.visibleSegments.push(t)}},Chart.prototype.hidePatternAnnotation=function(a){for(var e=this.visibleSegments.filter(function(t){return a==t[2]}),t=0;t<e.length;t++)this.visibleSegments.splice(this.visibleSegments.indexOf(e[t]),1)},Chart.prototype.drawSegments=function(){var e=this.xScale,a=this.yScale,t=this.chartData,n=this.chartContainer.selectAll("line.segment").data(this.visibleSegments);n.attr("x1",function(a){return e(t[a[0]].index)}).attr("x2",function(a){return e(t[a[1]].index)}).attr("y1",function(e){return a(t[e[0]].y0)}).attr("y2",function(e){return a(t[e[1]].y0)}),n.enter().append("svg:line").attr("class","segment").attr("x1",function(a){return e(t[a[0]].index)}).attr("x2",function(a){return e(t[a[1]].index)}).attr("y1",function(e){return a(t[e[0]].y0)}).attr("y2",function(e){return a(t[e[1]].y0)}).attr("stroke",function(){return"blue"}).attr("stroke-width",5).attr("clip-path","url(#clip-"+this.name+")"),n.exit().remove()},Chart.prototype.onMouseMove=function(){var h=d3.bisector(function(t){return t.index}).left,a=this.xScale,t=this.chartData,r=this.chartContainer,c=this.cursorText,n=a.invert(d3.mouse(this.overlay[0][0])[0]),e=h(t,n,1);if(e>-1&&e<t.length){var s=t[e-1],o=t[e],i=n-s.index>o.index-n?o:s;r.select("text.cursor_value").text(c(i)),r.select("line.cursor_line").style("stroke-opacity",.125).attr("x1",a(i.index)).attr("x2",a(i.index))}},Chart.prototype.onTouchMove=function(){var c=d3.bisector(function(t){return t.index}).left,n=this.xScale,t=this.chartData,r=this.chartContainer,h=this.cursorText,l=d3.touches(this.overlay[0][0]),i=n.invert(l[0][0]),e=c(t,i,1);if(e>-1&&e<t.length){var s=t[e-1],o=t[e],a=i-s.index>o.index-i?o:s;r.select("text.cursor_value").text(h(a)),r.select("line.cursor_line").style("stroke-opacity",.125).attr("x1",n(a.index)).attr("x2",n(a.index))}},Chart.prototype.updateCursor=function(){var t=this.height-this.margin.top-this.margin.bottom;this.chartContainer.select(".mouse_overlay").attr("width",this.width).attr("height",t),this.chartContainer.select(".cursor_line").attr("y2",t)},Chart.prototype.update=function(n,i,e,a){this.width=n,this.height=i,this.translateX=e,this.translateY=a;var t=this.height-this.margin.top-this.margin.bottom;this.svg.select("#clip-"+this.name).select(".clipRect").attr("width",this.width).attr("height",t),this.xScale.range([0,this.width]).domain(d3.extent(this.chartData.map(this.dataMapFuncX))),this.yScale.range([t,0]).domain(d3.extent(this.chartData.map(this.dataMapFuncY))),this.chartContainer.attr("transform","translate("+e+","+a+")"),this.chartContainer.select(".x.axis").attr("transform","translate(0, "+t+")").call(this.xAxis),this.chartContainer.select(".y.axis").attr("transform","translate("+this.width+", "+0+")").call(this.yAxis)},Chart.prototype.onBrush=function(n){var t,e,a;if(n.empty())t=this.chartData,e=d3.extent(this.chartData.map(this.dataMapFuncX)),a=d3.extent(this.chartData.map(this.dataMapFuncY));else{var i=n.extent();t=this.chartData.filter(function(a,t,e){return i[0]<=e[t].x&&e[t].x<=i[1]}),e=[d3.min(t,this.dataMapFuncX),d3.max(t,this.dataMapFuncX)];var r=t.map(function(t){return t.y0}),s=t.map(function(t){return t.y0});a=[d3.min(s),d3.max(r)]}this.xScale.domain(e),this.yScale.domain(a),this.chartContainer.select("path").datum(t).attr("d",this.pathFunction),this.chartContainer.select(".x.axis").call(this.xAxis),this.chartContainer.select(".y.axis").call(this.yAxis),this.drawSegments()}}function CandlestickChart(t){Chart.call(this,t),this.barMargin=t.barMargin,this.hasChartPath=!0,this.chartContainer.append("path").attr("class","chart").datum(this.chartData).attr("clip-path","url(#clip-"+this.name+")").attr("d",this.pathFunction).attr("stroke","black").attr("fill","none").attr("stroke-width","0.05%"),CandlestickChart.prototype.onBrush=function(e){var t,a,n;if(!e||e.empty())t=this.chartData,a=d3.extent(this.chartData.map(this.dataMapFuncX)),n=d3.extent(this.chartData.map(this.dataMapFuncY));else{var r=e.extent();t=this.chartData.filter(function(a,t,e){return r[0]<=e[t].x&&e[t].x<=r[1]}),a=[d3.min(t,this.dataMapFuncX),d3.max(t,this.dataMapFuncX)];var o=t.map(function(t){return t.y[1]}),h=t.map(function(t){return t.y[2]});n=[d3.min(h),d3.max(o)]}this.xScale.domain(a),this.yScale.domain(n);var i=this.hasChartPath,s=.4*(this.width-2*this.barMargin.side)/t.length;t.length>0&&s>this.barMargin.side?(i===!0&&(this.chartContainer.selectAll("path.chart").remove(),this.hasChartPath=!1),this.updateOHLC(t,s)):(i===!1?(this.chartContainer.insert("path","g.x.axis").attr("class","chart").datum(this.chartData).attr("clip-path","url(#clip-"+this.name+")").attr("d",this.pathFunction),this.hasChartPath=!0):this.chartContainer.select("path.chart").datum(this.chartData).attr("d",this.pathFunction),i!=this.hasChartPath&&(this.chartContainer.selectAll("rect.candlebody").remove(),this.chartContainer.selectAll("line.stem").remove(),this.chartContainer.selectAll("line.close_stem").remove(),this.chartContainer.selectAll("line.open_stem").remove()))},CandlestickChart.prototype.updateOHLC=function(i,n){var a=function(t){return t.y[0]==t.y[3]?"stroke:#000000;":t.y[0]>t.y[3]?"stroke:#FF0000;":"stroke:#006600;"},t=this.xScale,e=this.yScale,r=this.chartContainer.selectAll("line.stem").data(i);r.attr("x1",function(e){return t(e.index)}).attr("x2",function(e){return t(e.index)}).attr("y1",function(t){return e(t.y[2])}).attr("y2",function(t){return e(t.y[1])}).attr("style",function(t){return a(t)}),r.enter().append("svg:line").attr("class","stem").attr("x1",function(e){return t(e.index)}).attr("x2",function(e){return t(e.index)}).attr("y1",function(t){return e(t.y[2])}).attr("y2",function(t){return e(t.y[1])}).attr("style",function(t){return a(t)}),r.exit().remove();var s=this.chartContainer.selectAll("line.open_stem").data(i);s.attr("x1",function(e){return t(e.index)-n}).attr("x2",function(e){return t(e.index)}).attr("y1",function(t){return e(t.y[0])}).attr("y2",function(t){return e(t.y[0])}).attr("style",function(t){return a(t)}),s.enter().append("svg:line").attr("class","open_stem").attr("x1",function(e){return t(e.index)-n}).attr("x2",function(e){return t(e.index)}).attr("y1",function(t){return e(t.y[0])}).attr("y2",function(t){return e(t.y[0])}).attr("style",function(t){return a(t)}).attr("clip-path","url(#clip-"+this.name+")"),s.exit().remove();var o=this.chartContainer.selectAll("line.close_stem").data(i);o.attr("x1",function(e){return t(e.index)+n}).attr("x2",function(e){return t(e.index)}).attr("y1",function(t){return e(t.y[3])}).attr("y2",function(t){return e(t.y[3])}).attr("style",function(t){return a(t)}),o.enter().append("svg:line").attr("class","close_stem").attr("x1",function(e){return t(e.index)+n}).attr("x2",function(e){return t(e.index)}).attr("y1",function(t){return e(t.y[3])}).attr("y2",function(t){return e(t.y[3])}).attr("style",function(t){return a(t)}).attr("clip-path","url(#clip-"+this.name+")"),o.exit().remove()}}function BarChart(t){Chart.call(this,t),this.barMargin=t.barMargin,this.hasChartPath=!0,this.chartContainer.append("path").attr("class","chart").datum(this.chartData).attr("clip-path","url(#clip-"+this.name+")").attr("d",this.pathFunction).attr("stroke","black").attr("fill","none").attr("stroke-width","0.05%"),BarChart.prototype.onBrush=function(n){var t,e,a;if(n.empty())t=this.chartData,e=d3.extent(this.chartData.map(this.dataMapFuncX)),a=d3.extent(this.chartData.map(this.dataMapFuncY));else{var i=n.extent();t=this.chartData.filter(function(a,t,e){return i[0]<=e[t].x&&e[t].x<=i[1]}),e=[d3.min(t,this.dataMapFuncX),d3.max(t,this.dataMapFuncX)],a=d3.extent(t.map(this.dataMapFuncY))}this.xScale.domain(e),this.yScale.domain(a);var r=.4*(this.width-2*this.barMargin.side)/t.length;t.length>0&&r>this.barMargin.side?(this.hasChartPath===!0&&(this.id=this.chartContainer.select("path.chart").attr("id"),this.chartContainer.selectAll("path.chart").remove(),this.hasChartPath=!1),this.updateBarChart(t,r)):(this.chartContainer.selectAll("rect.bar").remove(),this.hasChartPath===!1?(this.chartContainer.insert("path","g.x.axis").attr("class","chart").datum(this.chartData).attr("clip-path","url(#clip-"+this.name+")").attr("d",this.pathFunction).attr("id",this.id),this.hasChartPath=!0):this.chartContainer.select("path").attr("d",this.pathFunction)),this.chartContainer.select(".x.axis").call(this.xAxis),this.chartContainer.select(".y.axis").call(this.yAxis)},BarChart.prototype.updateBarChart=function(i,t){var n=this.xScale,e=this.yScale,a=this.chartContainer.selectAll("rect.bar").data(i);a.attr("class","bar").attr("x",function(e){return n(e.index)-t/2}).attr("y",function(t){return isNaN(t.y0)?0:e(t.y0)}).attr("width",t).attr("height",function(){var t=e(0);return t}),a.enter().append("svg:rect").attr("class","bar").attr("x",function(e){return n(e.index)-t/2}).attr("y",function(t){return isNaN(t.y0)?0:e(t.y0)}).attr("width",t).attr("height",function(){var t=e(0);return t}).attr("clip-path","url(#clip-"+this.name+")"),a.exit().remove()}}function CanvasCandlestickChart(t){Chart.call(this,t),this.barMargin=t.barMargin,this.hasChartPath=!0;var e=this.height-this.margin.top-this.margin.bottom;d3.select("#chart").append("canvas").attr("id","canvas-"+this.name).attr("style","position: absolute; left: "+this.translateX+"px; top: "+this.translateY+"px; z-index: -100;").attr("width",this.width).attr("height",e),CanvasCandlestickChart.prototype.update=function(t,e,a,n){Chart.prototype.update.call(this,t,e,a,n);var i=document.getElementById("canvas-"+this.name);i.setAttribute("style","position: absolute; left: "+this.translateX+"px; top: "+this.translateY+"px; z-index: -100;")},CanvasCandlestickChart.prototype.onBrush=function(r,a,i){var t,e;if(r.empty())t=this.chartData;else if("undefined"!=typeof i&&null!=i)t=this.chartData.slice(i[0],i[1]+1);else{var l=r.extent();t=this.chartData.filter(function(a,t,e){return l[0]<=e[t].x&&e[t].x<=l[1]})}("undefined"==typeof a||null==a)&&(a=d3.extent(t.map(this.dataMapFuncX)));var d=t.map(function(t){return t.y[1]}),u=t.map(function(t){return t.y[2]});if(e=[d3.min(u),d3.max(d)],a[0]=a[0]-1,a[1]=a[1]+1,null!=this.yDomainMin&&(e[0]=this.yDomainMin),null!=this.yDomainMax&&(e[1]=this.yDomainMax),this.yDomainPadding>0){var h=(e[1]-e[0])*this.yDomainPadding;e[0]=e[0]-h,e[1]=e[1]+h}this.xScale.domain(a),this.yScale.domain(e);for(var o=0;o<this.chartIndicators.length;o++)this.chartIndicators[o].onBrush(this.chartContainer,r,a,i);var c=.4*(this.width-2*this.barMargin.side)/t.length;this.chartContainer.select(".x.axis").call(this.xAxis),this.chartContainer.select(".y.axis").call(this.yAxis),this.drawSegments(),this.hasChartPath=t.length>0&&c>this.barMargin.side?!1:!0;var n=document.getElementById("canvas-"+this.name);if(n.setAttribute("width",this.width),n.setAttribute("height",this.height-this.margin.top-this.margin.bottom),n.setAttribute("style","position: absolute; left: "+this.translateX+"px; top: "+this.translateY+"px; z-index: -100;"),n.getContext){var s=n.getContext("2d");s.clearRect(0,0,n.width,n.height),this.hasChartPath===!0?drawLineChart(s,this,t):drawOhlcChart(s,this,t,c)}}}function CanvasBarChart(t){Chart.call(this,t),this.barMargin=t.barMargin,this.hasChartPath=!0;var e=this.height-this.margin.top-this.margin.bottom;d3.select("#chart").append("canvas").attr("id","canvas-"+this.name).attr("style","position: absolute; left: "+this.translateX+"px; top: "+this.translateY+"px; z-index: -100;").attr("width",this.width).attr("height",e),CanvasBarChart.prototype.update=function(t,e,a,n){Chart.prototype.update.call(this,t,e,a,n);var i=document.getElementById("canvas-"+this.name);i.setAttribute("style","position: absolute; left: "+this.translateX+"px; top: "+this.translateY+"px; z-index: -100;")},CanvasBarChart.prototype.onBrush=function(s,e,n){var t,i;if(s.empty())t=this.chartData;else if("undefined"!=typeof n&&null!=n)t=this.chartData.slice(n[0],n[1]+1);else{var o=s.extent();t=this.chartData.filter(function(a,t,e){return o[0]<=e[t].x&&e[t].x<=o[1]})}i=d3.extent(t.map(this.dataMapFuncY)),("undefined"==typeof e||null==e)&&(e=d3.extent(t.map(this.dataMapFuncX))),e[0]=e[0]-1,e[1]=e[1]+1,null!=this.yDomainMin&&(i[0]=this.yDomainMin),null!=this.yDomainMax&&(i[1]=this.yDomainMax),this.xScale.domain(e),this.yScale.domain(i);var h=.45*(this.width-2*this.barMargin.side)/t.length;this.chartContainer.select(".x.axis").call(this.xAxis),this.chartContainer.select(".y.axis").call(this.yAxis),this.drawSegments(),this.hasChartPath=t.length>0&&h>this.barMargin.side?!1:!0;var a=document.getElementById("canvas-"+this.name);if(a.setAttribute("width",this.width),a.setAttribute("height",this.height-this.margin.top-this.margin.bottom),a.getContext){var r=a.getContext("2d");r.clearRect(0,0,a.width,a.height),this.hasChartPath===!0?drawLineChart(r,this,t,this.yDomainMin):drawBarChart(r,this,t,h)}}}function onClickSymbolButton(){var t=document.getElementById("symbolTextbox").value;t=t.toUpperCase(),(null==symbol||symbol!=t)&&(t=="poiu".toUpperCase()?createFileB():(symbol=t,CallService(symbol)))}function handleFileSelect(n){for(var t,i=n.target.files,a=0;t=i[a];a++){var e=new FileReader;e.onload=function(){return function(){patternBreakouts=[],patternBreakouts=readJsonFile(e.result),breakoutDayDict=getPatternBreakoutsByDate(),hasTabPage?updateAnnotationsTabs():createAnnotationTabPages()}}(t),e.readAsText(t)}}function onKeyPress(t){var e;window.event?e=t.keyCode:t.which&&(e=t.which),keychar=String.fromCharCode(e),buffer.push(keychar),buffer.length>4&&buffer.splice(0,buffer.length-4);var a=buffer.join().replace(new RegExp(",","g"),"");"poiu"==a&&createFileB()}function createFileB(){if(null==document.getElementById("filesButton")){var t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("id","filesButton"),t.setAttribute("name","files[]"),t.addEventListener("change",handleFileSelect,!1);var e=document.getElementById("symbolButton");e.parentNode.insertBefore(t,e.nextSibling)}document.getElementById("filesButton").click()}function toIntDate(t){return 1e4*t.getFullYear()+100*(t.getMonth()+1)+t.getDate()}function CallService(s){var e=e={top:10,right:80,bottom:10,left:10},a=window.innerWidth,n=window.innerHeight;a-=250;var h=9*a/10,r=8*n/10,i=document.getElementById("chartContentDiv"),o="-"+(n-1*e.top-e.bottom)/2+"px";i.style.marginTop=o;var t=document.getElementById("loadOverlay");if(null==t){t=document.createElement("div"),t.setAttribute("id","loadOverlay"),t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.width=h+"px",t.style.height=r+"px",t.style.backgroundColor="rgba(200, 200, 200, 0.8)",t.style.borderStyle="solid",t.style.borderWidth="1px";var c=document.getElementById("chart");c.appendChild(t)}var l={lines:17,length:2,width:10,radius:30,corners:1,rotate:0,direction:1,color:"#000",speed:2,trail:60,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"},u=document.getElementById("loadOverlay");new Spinner(l).spin(u),Type="POST",Url="http://localhost:8080/Service.svc/GetSymbol",Data='{"symbol": "'+s+'"}',ContentType="application/json; charset=utf-8",DataType="json",varProcessData=!0,$.ajaxSetup({error:function(t,e){ServiceFailed(t,e)}}),$.ajax({type:Type,url:Url,data:Data,contentType:ContentType,dataType:DataType,processdata:ProcessData,success:function(a){var n=ServiceSucceeded(a);if(n){var e=window.innerWidth,i=window.innerHeight;e-=250,chartCollection.update.call(chartCollection,e,i)}t.parentElement.removeChild(t)},error:ServiceFailed})}function ServiceSucceeded(t){if("json"==DataType&&null!=t.d){var d=t.d.Symbol,D=t.d.Exchange;$(".chart").remove(),$("#chart").children("canvas").remove(),$(".pattern_item").remove(),$(".pattern_item_selected").remove();var b=document.getElementById("resultText");b.innerHTML=D+" : "+d;var e=t.d.Close,C=t.d.High,p=t.d.Low,f=t.d.Open,l=t.d.Volume,r=t.d.Dates,v=r.map(function(a,t){var n=parseDate(String(a));return{index:t,x:n,y:[f[t],C[t],p[t],e[t]],y0:e[t]}}),y=r.map(function(e,t){var a=parseDate(String(e));return{index:t,x:a,y:[l[t]],y0:l[t]}});if(chartCollection=new ChartCollection(v,y),"undefined"!=typeof ta_asm){var u=new JSIL.BoxedVariable,m=new JSIL.BoxedVariable,g=20,c=new Array(e.length),h=new Array(e.length),o=new Array(e.length);ta_asm.TicTacTec.TA.Library.Core.Bbands(0,e.length-1,e,g,2,2,ta_asm.TicTacTec.TA.Library.Core_MAType.Sma,u,m,c,h,o);var s=u.get()+1,c=Array.apply(null,new Array(s)).map(Number.prototype.valueOf,0/0).concat(c),h=Array.apply(null,new Array(s)).map(Number.prototype.valueOf,0/0).concat(h),o=Array.apply(null,new Array(s)).map(Number.prototype.valueOf,0/0).concat(o),x="CandleStickChart",a=chartCollection.charts[x],i="Bband_Lower";mappedData=c.map(function(t,e){return{index:e,x:parseDate(String(r[e])),y:[t],y0:t}});var n=new LineChartSeries({data:mappedData,id:i,pathFunction:a.pathFunction});a.addIndicator(n),mappedData=h.map(function(t,e){return{index:e,x:parseDate(String(r[e])),y:[t],y0:t}}),i="Bband_Mid",n=new LineChartSeries({data:mappedData,id:i,pathFunction:a.pathFunction}),a.addIndicator(n),i="Bband_Upper",mappedData=o.map(function(t,e){return{index:e,x:parseDate(String(r[e])),y:[t],y0:t}}),n=new LineChartSeries({data:mappedData,id:i,pathFunction:a.pathFunction}),a.addIndicator(n)}if("undefined"!=typeof patternJsonData&&null!=patternJsonData){var w=updateSymbolAnnotationsList(d);chartCollection.charts[0].patternAnnotations=w}return!0}return!1}function ServiceFailed(t,e){0==t.status?console.log("You are offline!!\n Please Check Your Network."):404==t.status?console.log("Requested URL not found."):500==t.status?console.log("Internal Server Error."):"parsererror"==e?console.log("Error.\nParsing JSON Request failed."):"timeout"==e?console.log("Request Time out."):console.log("Unknow Error.\n"+t.responseText),wcf_error=!0,wcf_error===!0&&GetYahooData(symbol)}function GetYahooData(t){var e=historical_prices();e(t,function(e){if(null==e){$(".chart").remove(),$("#chart").children("canvas").remove(),$(".pattern_item").remove(),$(".pattern_item_selected").remove();var n=document.getElementById("resultText");n.innerHTML=t;var a=document.getElementById("loadOverlay");a.parentElement.removeChild(a)}$(".chart").remove(),$("#chart").children("canvas").remove(),$(".pattern_item").remove(),$(".pattern_item_selected").remove();var n=document.getElementById("resultText");if(n.innerHTML=t,data=e.map(function(t,i){var a=parseFloat(t["adj close"]),n=a/t.close,r=d3.time.format("%Y-%m-%d").parse,s=r(t.date);return{index:e.length-1-i,x:s,y:[t.open*n,t.high*n,t.low*n,a],y0:a,volume:parseFloat(t.volume)}}),data=data.reverse(),volume_data=e.map(function(t,a){var n=d3.time.format("%Y-%m-%d").parse,i=n(t.date);return{index:e.length-1-a,x:i,y:[parseFloat(t.volume)],y0:parseFloat(t.volume)}}),volume_data=volume_data.reverse(),chartCollection=new ChartCollection(data,volume_data),"undefined"!=typeof patternJsonData&&null!=patternJsonData){var r=updateSymbolAnnotationsList(t);chartCollection.charts[0].patternAnnotations=r}if("undefined"!=typeof chartCollection&&null!=chartCollection){var i=window.innerWidth,s=window.innerHeight;i-=250,chartCollection.update.call(chartCollection,i,s)}var a=document.getElementById("loadOverlay");a.parentElement.removeChild(a)})}function historical_prices(){function e(){var o=[n,i],e={};o.forEach(function(t,a){var n=["from","to"][a];d3.keys(t).forEach(function(a){var i=r[n][a];e[i]=t[a]})}),e.s=t,e.g="d",e.ignore=".csv";var a="";for(var s in e)a=a+"&"+s+"="+e[s];return base_finance_url+a}function a(n,a){t=n;var i="select%20*%20from%20html%20where%20url%3D'"+encodeURIComponent(e())+"'&format=json",r=yql_url+i;d3.json(r,function(i,t){if(!t)return a(t);if(null==t.query.results)return a(null),null;var e=t.query.results.body.p,n=e.slice(0,42).trim().toLowerCase()+"\n";e.slice(42).split(" ").forEach(function(t){n+=t+"\n"}),a(d3.csv.parse(n))})}var t="AAPL",n={month:3,day:12,year:(new Date).getFullYear()-5},i={month:(new Date).getMonth(),day:(new Date).getDate(),year:(new Date).getFullYear()},r={from:{month:"a",day:"b",year:"c"},to:{month:"d",day:"e",year:"f"}};
return a}function LineChartSeries(t){this.indicatorData=t.data,this.id=t.id,this.pathFunction=t.pathFunction,LineChartSeries.prototype.onBrush=function(n,e,r,t){if(!e||e.empty())n.selectAll("#"+this.id).datum(this.indicatorData).attr("d",this.pathFunction);else{var a;if("undefined"!=typeof t&&null!=t)a=this.indicatorData.slice(t[0],t[1]+1);else{var i=e.extent();a=this.indicatorData.filter(function(a,t,e){return i[0]<=e[t].x&&e[t].x<=i[1]})}n.selectAll("#"+this.id).datum(a).attr("d",this.pathFunction)}}}function readJsonFile(r){var a=JSON.parse(r);patternJsonData=a[1];var t=a[0];t.sort(function(t,e){return parseInt(e[1])-parseInt(t[1])});for(var n=[],e=0;e<t.length;e++){var i=t[e],s=new PatternBreakouts(i[0],i[1]);n.push(s)}return n}function getPatternBreakoutsByDate(){for(var e=[],n=[],a=0;a<patternBreakouts.length;a++){var t=patternBreakouts[a].getDate(),i=patternBreakouts[a].getSymbol();null==e[t]&&(e[t]=[]),-1==$.inArray(t,n)&&n.push(t),-1==$.inArray(i,e[t])&&e[t].push(i)}return{dates:n,dict:e}}function PatternSegment(t,e){this.startDate=t,this.endDate=e}function PatternAnnotation(){this.patternId=-1,this.patternName="",this.patternSegments=[]}function parsePatternJson(i){for(var r=[],t=0;t<i.length;t++){var e=i[t],s=e.Name,a=new PatternAnnotation;a.patternName=s,a.patternId=t;for(var n=0;n<e.PointCount-1;n++){var o=new PatternSegment(e.PointDates[n],e.PointDates[n+1]);a.patternSegments.push(o)}r.push(a)}return r}function createAnnotationTabPages(){document.getElementById("annotationsTabDiv"),require(["dijit/layout/TabContainer","dijit/layout/ContentPane","dojo/domReady!"],function(s,e){var n=270,t=new s({id:"annotationsTabContainer",style:"height: "+n+"px; width: 290px;"},"annotationsTabDiv"),i=document.createElement("ul");i.setAttribute("id","tabpane_breakoutday_list");var h=new e({id:"breakoutDayTabContentPane",title:"Breakout Day",content:i,startup:updateAnnotationsTabs});t.addChild(h);var a=document.createElement("ul");a.setAttribute("id","tabpane_symbol_list");var o=new e({id:"symbolsTabContentPane",title:"Symbols",content:a});t.addChild(o);var r=document.createElement("ul");r.setAttribute("id","tabpane_annotation_list");var c=new e({id:"annotationsTabContentPane",title:"Annotations",content:r});t.addChild(c),t.startup();var l=document.getElementById("annotationsTabContentDiv"),u="-"+n/2+"px";l.style.marginTop=u,hasTabPage=!0})}function updateAnnotationsTabs(){require(["dojo"],function(){$("#tabpane_breakoutday_list .breakout_date_item").remove();var t=breakoutDayDict;$(t.dates).each(function(e){$("<li>").attr("class","breakout_date_item").attr("onmouseover","listItemMouseOver(this)").attr("onmouseout","listItemMouseOut(this)").attr("onclick","breakoutDayItemClick(this)").append(t.dates[e]).appendTo("#tabpane_breakoutday_list")})})}function updateAnnotationLists(){var r=document.getElementById("breakout_day_cell");if(null==r){var n=document.getElementById("symbol_table").getElementsByTagName("tbody")[0].getElementsByTagName("tr")[0],t=document.createElement("td");t.setAttribute("id","breakout_day_cell");var e=document.createElement("div");e.setAttribute("style","height: 300px; padding-left: 10px; padding-right: 10px; overflow:scroll;");var a=document.createElement("ul");a.setAttribute("id","breakout_date_list"),e.appendChild(a),t.appendChild(e),n.insertBefore(t,n.children[0]),t=document.createElement("td"),t.setAttribute("id","symbol_list_cell"),e=document.createElement("div"),e.setAttribute("style","height: 300px; width: 75px; overflow:scroll;"),a=document.createElement("ul"),a.setAttribute("id","symbol_list"),e.appendChild(a),t.appendChild(e),n.insertBefore(t,n.children[1]),t=document.createElement("td"),t.setAttribute("id","pattern_list_cell"),e=document.createElement("div"),e.setAttribute("style","height: 300px; width: 150px; overflow:scroll;"),a=document.createElement("ul"),a.setAttribute("id","pattern_list"),e.appendChild(a),t.appendChild(e),n.insertBefore(t,n.children[2])}else $("#breakout_date_list .breakout_date_item").remove(),$("#symbol_list .symbol_item").remove(),$("#pattern_list .pattern_item").remove(),$("#pattern_list .pattern_item_selected").remove();var i=breakoutDayDict;$(i.dates).each(function(t){$("<li>").attr("class","breakout_date_item").attr("onmouseover","listItemMouseOver(this)").attr("onmouseout","listItemMouseOut(this)").attr("onclick","breakoutDayItemClick(this)").append(i.dates[t]).appendTo("#breakout_date_list")})}function updateSymbolAnnotationsList(r){if("undefined"!=typeof patternJsonData&&null!=patternJsonData){var a=patternJsonData[r];if(null!=a)for(var t=parsePatternJson(a),e=0;e<t.length;e++){var n=t[e].patternName,i=t[e].patternId;$("<li>").attr("class","pattern_item").attr("onmouseover","listItemMouseOver(this)").attr("onmouseout","listItemMouseOut(this)").attr("onclick","annotationItemClick(this)").attr("segment_id",i).append(n).appendTo("#pattern_list"),$("<li>").attr("class","pattern_item").attr("onmouseover","listItemMouseOver(this)").attr("onmouseout","listItemMouseOut(this)").attr("onclick","annotationItemClick(this)").attr("segment_id",i).append(n).appendTo("#tabpane_annotation_list")}return t}return null}function breakoutDayItemClick(e){var t=breakoutDayDict.dict[e.textContent];$("#symbol_list .symbol_item").remove(),$(t).each(function(e){$("<li>").attr("class","symbol_item").attr("onmouseover","listItemMouseOver(this)").attr("onmouseout","listItemMouseOut(this)").attr("onclick","symbolItemClick(this)").append(t[e]).appendTo("#symbol_list")}),$("#tabpane_symbol_list  .symbol_item").remove(),$(t).each(function(e){$("<li>").attr("class","symbol_item").attr("onmouseover","listItemMouseOver(this)").attr("onmouseout","listItemMouseOut(this)").attr("onclick","symbolItemClick(this)").append(t[e]).appendTo("#tabpane_symbol_list")})}function symbolItemClick(e){var t=e.textContent;(null==symbol||symbol!=t)&&(symbol=t,CallService(symbol))}function annotationItemClick(t){if(t.style.backgroundColor="","pattern_item"==t.getAttribute("class")){t.setAttribute("class","pattern_item_selected");var e=t.getAttribute("segment_id");chartCollection.charts[0].showPatternAnnotation(e)}else if("pattern_item_selected"==t.getAttribute("class")){t.setAttribute("class","pattern_item");var e=t.getAttribute("segment_id");chartCollection.charts[0].hidePatternAnnotation(e)}chartCollection.charts[0].drawSegments()}function listItemMouseOver(t){t.style.backgroundColor="Blue"}function listItemMouseOut(t){t.style.backgroundColor=""}window.onresize=function(){var t;window.onresize=function(){clearTimeout(t),t=setTimeout(function(){var t=window.innerWidth,e=window.innerHeight;t-=250,"undefined"!=typeof chartCollection&&null!=chartCollection&&chartCollection.update(t,e)},100)}},CandlestickChart.prototype=Object.create(Chart.prototype),CandlestickChart.constructor=CandlestickChart,BarChart.prototype=Object.create(Chart.prototype),BarChart.constructor=BarChart,CanvasCandlestickChart.prototype=Object.create(Chart.prototype),CanvasCandlestickChart.constructor=CanvasCandlestickChart,CanvasBarChart.prototype=Object.create(Chart.prototype),CanvasBarChart.constructor=CanvasBarChart;var symbol=null;hasTabPage=!1;var buffer=[],Type,Url,Data,ContentType,DataType,ProcessData,parseDate=d3.time.format("%Y%m%d").parse,chartCollection,yql_url="http://query.yahooapis.com/v1/public/yql?q=",base_finance_url="http://ichart.finance.yahoo.com/table.csv?",patternBreakouts=[],breakoutDayDict,PatternBreakouts=function(){function t(t,e){this._symbol=t,this._date=e}return t.prototype.getSymbol=function(){return this._symbol},t.prototype.setSymbol=function(t){this._symbol=t},t.prototype.getDate=function(){return this._date},t.prototype.setDate=function(t){this._date=t},t}();